# 知识库构建方案

## 1. 总体架构设计

### 1.1 MonoRepo统一管理架构

```
knowledge-base/                    # 工作区根目录
├── pyproject.toml                # 根项目配置（包管理器配置）
├── Makefile                      # 统一命令管理
├── .gitignore                    # 全局git忽略
├── README.md                     # 项目总览
├── tools/                        # 共享工具和脚本
│   ├── scripts/                  # 全局脚本
│   │   ├── update-nav.py         # 迁移现有导航更新脚本
│   │   └── deploy.sh             # 统一部署脚本
│   └── configs/                  # 共享配置
├── packages/                     # 子项目目录
│   ├── docs/                     # 文档项目
│   │   ├── mkdocs.yml            # mkdocs配置
│   │   ├── docs/                 # 实际文档内容
│   │   ├── overrides/            # 迁移主题覆盖文件
│   │   └── requirements.txt      # Python依赖
│   ├── knowledge_sync/           # 文档同步服务包
│   │   ├── __init__.py
│   │   ├── gitlab_syncer.py
│   │   ├── confluence_syncer.py
│   │   └── main.py
│   ├── knowledge_api/            # API服务包
│   │   ├── __init__.py
│   │   ├── main.py
│   │   ├── models.py
│   │   └── routers/
│   ├── knowledge_mcp/            # MCP服务包
│   │   ├── __init__.py
│   │   ├── server.py
│   │   └── client.py
│   └── knowledge_common/         # 共享模块
│       ├── __init__.py
│       ├── config.py            # 统一配置管理
│       ├── database.py          # 数据库连接
│       ├── logging.py           # 日志配置
│       └── utils.py             # 通用工具
├── config/                       # 配置文件
│   ├── settings.yaml
│   └── environments/
├── docker/                       # Docker配置
│   ├── Dockerfile.sync
│   ├── Dockerfile.api
│   ├── Dockerfile.mcp
│   └── docker-compose.yml
├── tests/                        # 统一测试
│   ├── conftest.py
│   ├── test_sync/
│   ├── test_api/
│   └── test_mcp/
├── dist/                         # 构建输出目录
│   └── docs/                     # 文档构建输出
├── .env.example                  # 环境变量模板
└── setup.py                     # 可选的向后兼容安装文件
```

### 1.3 技术栈 (MonoRepo架构)

- **MonoRepo管理**: Python包管理 (setuptools + pip-tools)
- **后端**: Python 3.8+ (包结构化设计)
- **依赖管理**: pyproject.toml + pip-tools (统一Python包管理)
- **Web框架**: FastAPI (API服务)
- **文档生成**: MkDocs + mkdocs-material (保持现有配置)
- **搜索引擎**: Whoosh + jieba (轻量级全文搜索，支持中文分词)
- **数据存储**: Git仓库 + PostgreSQL (元数据)
- **容器化**: Docker + Docker Compose (统一构建)
- **开发工具**: Black + isort + MyPy + Pytest (统一代码规范)
- **CI/CD**: GitLab CI (Python工作流)

## 2. MonoRepo依赖管理架构

### 2.1 根目录配置 (Makefile)

```makefile
# Makefile - Python项目统一管理
.PHONY: help install dev test lint clean docs-dev docs-build docs-deploy

help:  ## 显示帮助信息
	@echo "可用命令:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'

install:  ## 安装依赖
	pip install -e .[all]

dev:  ## 启动开发环境
	python -m uvicorn packages.knowledge_api.main:app --reload &
	cd packages/docs && mkdocs serve

docs-dev:  ## 启动文档开发服务器
	cd packages/docs && mkdocs serve

docs-build:  ## 构建文档
	cd packages/docs && mkdocs build

docs-deploy:  ## 部署文档
	cd packages/docs && mkdocs gh-deploy

sync-start:  ## 启动同步服务
	python -m packages.knowledge_sync.main

api-start:  ## 启动API服务
	python -m uvicorn packages.knowledge_api.main:app --reload

mcp-start:  ## 启动MCP服务
	python -m packages.knowledge_mcp.server

update-nav:  ## 更新导航
	python packages/knowledge_sync/update_nav.py

test:  ## 运行测试
	pytest tests/

lint:  ## 代码检查
	black packages/ && isort packages/ && mypy packages/

clean:  ## 清理缓存
	find . -name '__pycache__' -exec rm -rf {} + && find . -name '*.pyc' -delete
```

### 2.2 统一依赖配置 (pyproject.toml)

```toml
[project]
name = "knowledge-base"
version = "1.0.0"
description = "企业知识库管理系统"
dependencies = [
    # 核心框架
    "fastapi>=0.104.0",
    "uvicorn[standard]>=0.24.0",
    "aiohttp>=3.9.0",
    
    # 数据库
    "sqlalchemy>=2.0.0",
    "asyncpg>=0.29.0",
    "alembic>=1.12.0",
    
    # 配置管理
    "pydantic>=2.5.0",
    "pydantic-settings>=2.1.0",
    "pyyaml>=6.0.1",
    "python-dotenv>=1.0.0",
    
    # 通用工具
    "requests>=2.31.0",
    "structlog>=23.2.0",
    "click>=8.1.0",
]

[project.optional-dependencies]
# 同步服务依赖
sync = [
    "python-gitlab>=4.2.0",
    "GitPython>=3.1.40",
    "atlassian-python-api>=3.41.0",
    "html2text>=2020.1.16",
]

# API服务依赖
api = [
    "whoosh>=2.7.4",
    "python-multipart>=0.0.6",
    "jieba>=0.42.1",  # 中文分词
]

# MCP服务依赖
mcp = [
    "mcp>=1.0.0",
    "websockets>=12.0",
]

# Web服务依赖
web = [
    "mkdocs>=1.5.3",
    "mkdocs-material>=9.4.0",
]

# 开发依赖
dev = [
    "pytest>=7.4.0",
    "black>=23.11.0",
    "isort>=5.12.0",
    "mypy>=1.7.0",
    "pre-commit>=3.6.0",
]

# 完整安装
all = ["knowledge-base[sync,api,mcp,web,dev]"]

[project.scripts]
kb-sync = "knowledge_sync.main:main"
kb-api = "knowledge_api.main:main"
kb-mcp = "knowledge_mcp.server:main"
kb-web = "knowledge_web.main:main"
```

### 2.3 子项目配置示例

#### packages/docs/requirements.txt
```txt
# 文档生成依赖
mkdocs>=1.5.3
mkdocs-material>=9.4.0
mkdocs-minify-plugin>=0.7.1
pymdown-extensions>=10.3.0
mkdocs-git-revision-date-localized-plugin>=1.2.0
mkdocs-git-authors-plugin>=0.7.0
mkdocs-tags-plugin>=0.1.0
```

### 2.4 共享模块设计 (knowledge_common)

```python
# packages/knowledge_common/config.py - 统一配置管理
from pydantic_settings import BaseSettings

class AppConfig(BaseSettings):
    # 环境配置
    environment: str = "development"
    debug: bool = False

    # 数据库配置
    database_url: str = "postgresql+asyncpg://..."

    # GitLab配置
    gitlab_url: str
    gitlab_token: str

    # Confluence配置
    confluence_url: str
    confluence_token: str

    # 同步配置
    docs_output_dir: str = "packages/docs/docs"
    auto_update_nav: bool = True
    nav_script_path: str = "packages/docs/scripts/update_nav.py"

# 全局配置实例
settings = AppConfig()
```

### 2.5 开发工具统一化

```bash
# 环境设置
pip install -e .[all]              # 安装Python包

# 统一命令 (通过Makefile)
make docs-dev                      # 文档开发服务器
make docs-build                    # 构建文档
make docs-deploy                   # 部署文档

make sync-start                    # 启动同步服务
make api-start                     # 启动API服务
make mcp-start                     # 启动MCP服务

make dev                           # 同时启动docs和api服务
make test                          # 运行测试
make lint                          # 代码检查
make clean                         # 清理缓存

# 单独项目命令
cd packages/docs && mkdocs serve   # 仅启动文档服务
python -m packages.knowledge_api.main  # 直接启动API

# 包管理命令
kb-sync                           # 启动同步服务 (安装后)
kb-api                            # 启动API服务 (安装后)
kb-mcp                            # 启动MCP服务 (安装后)
```

## 3. GitLab文档同步模块

### 3.1 设计思路

```python
# 伪代码示例
class GitLabSyncer:
    def __init__(self, gitlab_url, token, projects):
        self.gitlab = gitlab.Gitlab(gitlab_url, token)
        self.projects = projects
    
    def sync_documents(self):
        for project in self.projects:
            # 克隆或更新项目
            repo = self.clone_or_update(project)
            # 扫描文档目录
            docs = self.scan_docs_directory(repo, project.docs_path)
            # 处理文档
            self.process_documents(docs, project)
    
    def scan_docs_directory(self, repo, docs_path):
        # 递归扫描指定目录下的Markdown文件
        # 提取文档元数据（标题、作者、更新时间等）
        # 返回文档列表
        pass
```

### 4.2 功能特性

- **多项目支持**: 可配置多个GitLab项目的文档目录
- **增量同步**: 仅同步有变更的文档
- **版本跟踪**: 记录文档的Git提交历史
- **分支管理**: 支持多分支文档版本
- **权限控制**: 基于GitLab访问权限

### 4.3 配置示例

```yaml
gitlab:
  url: "https://gitlab.example.com"
  token: "${GITLAB_TOKEN}"
  projects:
    - name: "项目A文档"
      project_id: 123
      docs_path: "docs/"
      branch: "main"
      target_path: "docs/project-a/"
    - name: "项目B文档"
      project_id: 456
      docs_path: "documentation/"
      branch: "develop"
      target_path: "docs/project-b/"
```

## 4. Confluence文档同步模块

### 4.1 设计思路

```python
# 伪代码示例
class ConfluenceSyncer:
    def __init__(self, base_url, username, token):
        self.confluence = Confluence(base_url, username, token)
    
    def sync_spaces(self, spaces_config):
        for space in spaces_config:
            # 获取空间页面列表
            pages = self.get_space_pages(space.key)
            # 转换为Markdown
            for page in pages:
                markdown = self.convert_to_markdown(page)
                self.save_document(markdown, space, page)
    
    def convert_to_markdown(self, page):
        # 使用pandoc或自定义转换器
        # 处理Confluence特有的标记
        # 转换图片和附件链接
        pass
```

### 4.2 功能特性

- **空间批量同步**: 支持多个Confluence空间
- **格式转换**: 自动转换为Markdown格式
- **图片处理**: 下载并本地化图片资源
- **链接重写**: 重写内部链接为相对路径
- **层级保持**: 保持原有的页面层级结构

### 4.3 配置示例

```yaml
confluence:
  base_url: "https://company.atlassian.net/wiki"
  username: "${CONFLUENCE_USER}"
  token: "${CONFLUENCE_TOKEN}"
  spaces:
    - key: "DEV"
      name: "开发文档"
      target_path: "docs/dev/"
      include_attachments: true
    - key: "API"
      name: "API文档"
      target_path: "docs/api/"
      include_attachments: false
```

## 5. MkDocs配置和主题定制

### 5.1 增强配置

```yaml
# mkdocs.yml 增强版
site_name: 企业知识库
site_description: 统一的企业知识管理平台

theme:
  name: material
  language: zh
  custom_dir: overrides
  features:
    - navigation.tabs
    - navigation.sections
    - navigation.expand
    - navigation.indexes
    - search.suggest
    - search.highlight
    - content.code.copy
    - content.tabs.link
    - toc.integrate

plugins:
  - search:
      lang:
        - zh
        - en
  - git-revision-date-localized:
      type: datetime
      timezone: Asia/Shanghai
  - git-authors
  - tags
  - versioning:
      version_selector: true
      css_dir: css/
      javascript_dir: js/

extra:
  version:
    provider: mike
    default: latest
  analytics:
    provider: google
    property: GA_MEASUREMENT_ID
```

### 5.2 自定义主题

- **多版本支持**: 集成mike插件实现版本切换
- **增强搜索**: 支持中文分词和智能提示
- **响应式设计**: 适配移动端和桌面端
- **代码高亮**: 支持多种编程语言
- **数学公式**: 支持LaTeX公式渲染

## 6. API服务模块

### 6.1 RESTful API设计

```python
# 伪代码示例
from fastapi import FastAPI, Query
from typing import List, Optional

app = FastAPI(title="知识库API", version="1.0.0")

@app.get("/api/documents")
async def search_documents(
    q: str = Query(..., description="搜索关键词"),
    category: Optional[str] = None,
    version: Optional[str] = None,
    limit: int = Query(20, le=100)
):
    # 搜索文档
    # 返回结果
    pass

@app.get("/api/documents/{doc_id}")
async def get_document(doc_id: str):
    # 获取特定文档
    pass

@app.get("/api/categories")
async def get_categories():
    # 获取文档分类
    pass
```

### 6.2 功能接口

- **文档搜索**: 全文搜索和元数据搜索，支持中文分词
- **文档获取**: 按ID或路径获取文档内容
- **分类浏览**: 获取文档分类和导航结构
- **版本管理**: 版本列表和切换
- **统计信息**: 文档数量、更新统计等

### 6.3 中文搜索实现

```python
# 伪代码示例 - 中文搜索配置
from whoosh.analysis import StandardAnalyzer
import jieba

class ChineseAnalyzer(StandardAnalyzer):
    def __init__(self):
        super().__init__()
        # 加载用户词典
        jieba.load_userdict("custom_dict.txt")

    def __call__(self, text):
        # 使用jieba进行中文分词
        words = jieba.cut_for_search(text)
        return [word for word in words if len(word.strip()) > 0]

# Whoosh索引配置
from whoosh.fields import Schema, TEXT, ID
from whoosh.index import create_index

schema = Schema(
    id=ID(stored=True),
    title=TEXT(stored=True, analyzer=ChineseAnalyzer()),
    content=TEXT(analyzer=ChineseAnalyzer()),
    category=TEXT(stored=True)
)
```

## 7. MCP服务模块

### 7.1 MCP协议实现

```python
# 伪代码示例
from mcp import MCPServer
from mcp.types import Tool, TextContent

class KnowledgeBaseMCP(MCPServer):
    def __init__(self):
        super().__init__()
        self.register_tools()

    def register_tools(self):
        self.add_tool(Tool(
            name="search_knowledge",
            description="搜索知识库内容",
            inputSchema={
                "type": "object",
                "properties": {
                    "query": {"type": "string"},
                    "category": {"type": "string"}
                }
            }
        ))

    async def call_tool(self, name: str, arguments: dict):
        if name == "search_knowledge":
            return await self.search_knowledge(arguments)
```

### 6.2 服务能力

- **知识检索**: 提供知识查询接口
- **文档搜索**: 支持全文搜索和分类搜索
- **内容获取**: 返回完整文档内容
- **标准协议**: 遵循MCP协议规范

## 7. Web服务模块

### 7.1 MkDocs服务

- **文档展示**: 使用MkDocs生成静态网站
- **搜索功能**: 内置全文搜索
- **响应式设计**: 支持移动设备访问
- **版本管理**: 支持多版本文档切换


## 8. MonoRepo容器化部署

### 8.1 统一Docker配置

```yaml
# docker/docker-compose.yml (MonoRepo架构)
version: '3.8'

services:
  database:
    image: postgres:15
    environment:
      POSTGRES_DB: knowledge_base
      POSTGRES_USER: kb_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kb_user -d knowledge_base"]
      interval: 30s

  sync-service:
    build:
      context: ..                    # MonoRepo根目录
      dockerfile: docker/Dockerfile.sync
    environment:
      - GITLAB_TOKEN=${GITLAB_TOKEN}
      - CONFLUENCE_TOKEN=${CONFLUENCE_TOKEN}
      - ENVIRONMENT=production
    volumes:
      - ../mkdocs/docs:/app/mkdocs/docs
      - ../mkdocs/scripts:/app/mkdocs/scripts:ro
      - ../config:/app/config:ro
    depends_on:
      database:
        condition: service_healthy
    restart: unless-stopped

  api-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    ports:
      - "8080:8080"
    environment:
      - ENVIRONMENT=production
    volumes:
      - ../mkdocs/docs:/app/mkdocs/docs:ro
      - ../config:/app/config:ro
    depends_on:
      database:
        condition: service_healthy
    restart: unless-stopped

  mcp-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    ports:
      - "9000:9000"
    environment:
      - API_BASE_URL=http://api-service:8080
    depends_on:
      - api-service
    restart: unless-stopped

  web-service:
    build:
      context: ../mkdocs           # 现有mkdocs目录
    ports:
      - "8000:8000"
    volumes:
      - ../mkdocs:/app:ro
    restart: unless-stopped

volumes:
  postgres_data:
```

### 8.2 MonoRepo Dockerfile

```dockerfile
# docker/Dockerfile.sync
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# 复制MonoRepo项目文件
COPY pyproject.toml ./
COPY packages/ ./packages/
COPY config/ ./config/

# 安装特定服务依赖
RUN pip install --no-cache-dir -e .[sync,prod]

# 创建非root用户
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# 使用统一命令启动
CMD ["kb-sync"]
```

## 9. 传统部署架构

### 9.1 Docker Compose配置

```yaml
version: '3.8'
services:
  knowledge-sync:
    build: ./sync-service
    environment:
      - GITLAB_TOKEN=${GITLAB_TOKEN}
      - CONFLUENCE_TOKEN=${CONFLUENCE_TOKEN}
    volumes:
      - ./docs:/app/docs
    depends_on:
      - database
  
  mkdocs-web:
    build: ./web-service
    ports:
      - "8000:8000"
    volumes:
      - ./docs:/app/docs
      - ./site:/app/site
  
  api-service:
    build: ./api-service
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://user:pass@database:5432/kb
    depends_on:
      - database
  
  mcp-service:
    build: ./mcp-service
    ports:
      - "9000:9000"
    depends_on:
      - api-service
  
  database:
    image: postgres:13
    environment:
      - POSTGRES_DB=knowledge_base
      - POSTGRES_USER=kb_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 9.2 CI/CD流程

```yaml
# .gitlab-ci.yml
stages:
  - sync
  - build
  - test
  - deploy

sync-docs:
  stage: sync
  script:
    - python sync_service/main.py
  artifacts:
    paths:
      - docs/
    expire_in: 1 hour

build-site:
  stage: build
  script:
    - mkdocs build
  dependencies:
    - sync-docs
  artifacts:
    paths:
      - site/

deploy-production:
  stage: deploy
  script:
    - docker-compose up -d
  only:
    - main
```

## 10. 配置管理

### 10.1 环境配置

```yaml
# config/production.yml
database:
  url: "postgresql://user:pass@db:5432/kb"
  pool_size: 10

sync:
  schedule: "0 */6 * * *"  # 每6小时同步一次
  
search:
  engine: "whoosh"  # 轻量级搜索引擎
  index_path: "data/search_index"
  chinese_analyzer: true  # 启用中文分词
  min_word_len: 1  # 中文单字搜索支持

web:
  host: "0.0.0.0"
  port: 8000
  reload: false

api:
  cors_origins:
    - "https://claude.ai"
    - "https://your-domain.com"
  rate_limit: "100/minute"

mcp:
  host: "0.0.0.0"
  port: 9000
  max_connections: 100
```

### 10.2 文档源配置

```yaml
# config/sources.yml
sources:
  gitlab:
    - name: "产品文档"
      project_id: 123
      docs_path: "docs/"
      branch: "main"
      category: "product"
    
  confluence:
    - space_key: "DEV"
      name: "开发指南"
      category: "development"
```

## 11. 监控和维护

### 11.1 日志记录

- **同步日志**: 记录每次同步的结果和错误
- **API日志**: 记录API调用和性能指标
- **搜索日志**: 记录搜索查询和结果
- **错误跟踪**: 集成Sentry等错误监控

### 11.2 健康检查

```python
# 伪代码示例
@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.now(),
        "version": "1.0.0",
        "services": {
            "database": await check_database(),
            "gitlab": await check_gitlab_connection(),
            "confluence": await check_confluence_connection()
        }
    }
```

## 12. 扩展功能

### 12.1 高级特性

- **智能推荐**: 基于用户行为推荐相关文档
- **多语言支持**: 支持中英文切换
- **权限管理**: 细粒度的文档访问控制
- **协作功能**: 文档评论和反馈
- **分析统计**: 文档访问统计和热门内容分析

### 12.2 集成扩展

- **Slack/Teams集成**: 在聊天工具中查询知识库
- **IDE插件**: VSCode等IDE的知识库插件
- **移动应用**: 移动端知识库访问
- **第三方集成**: 与其他企业系统集成


### 成功指标

- **技术指标**: 99.9%服务可用性，<100ms搜索响应时间
- **业务指标**: 文档访问量提升，开发者使用率
- **用户体验**: MCP服务使用反馈良好